<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tengwar AI â€” Always Thinking</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%2308080D' rx='16' width='100' height='100'/><text x='50' y='68' text-anchor='middle' font-size='52' font-family='serif' fill='%23C9A84C'>ðŸ§ </text></svg>">
<link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'><rect fill='%2308080D' rx='32' width='180' height='180'/><text x='90' y='120' text-anchor='middle' font-size='96' font-family='serif' fill='%23C9A84C'>ðŸ§ </text></svg>">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=EB+Garamond:ital,wght@0,400;0,500;1,400&family=JetBrains+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<style>
:root {
    --gold: #C9A84C; --gold-b: #E8D48B; --gold-d: #7A6830;
    --bg: #08080D; --bg2: #0E0E16; --bg3: #16161F; --bg4: #1E1E2A;
    --tx: #E8E4DC; --tx2: #9A9488; --txd: #5C584E;
    --bdr: rgba(201,168,76,0.12);
    --thought: rgba(201,168,76,0.04);
    --user-bg: rgba(201,168,76,0.08);
    --ai-bg: rgba(255,255,255,0.03);
}
* { margin:0; padding:0; box-sizing:border-box; }
body { background:var(--bg); color:var(--tx); font-family:'EB Garamond',Georgia,serif; font-size:17px; line-height:1.65; height:100vh; overflow:hidden; }
body::before { content:''; position:fixed; inset:0; background:radial-gradient(ellipse at 30% 0%, rgba(201,168,76,.02) 0%, transparent 50%), radial-gradient(ellipse at 70% 100%, rgba(201,168,76,.015) 0%, transparent 50%); pointer-events:none; z-index:0; }

/* Layout */
.app { display:grid; grid-template-columns:1fr 380px; grid-template-rows:auto 1fr; height:100vh; height:100dvh; position:relative; z-index:1; }
@media (max-width:900px) {
    .app { grid-template-columns:1fr; }
    .thought-panel { display:none; }
    .chat-panel { height:calc(100dvh - 52px); }
    header { padding:.5rem 1rem; }
    .logo span { display:none; }
    .status { gap:.6rem; }
    .input-area { padding:.6rem .8rem; padding-bottom:calc(.6rem + env(safe-area-inset-bottom)); }
    .messages { padding:1rem; }
    .msg { max-width:92%; }
}

/* Header */
header { grid-column:1/-1; display:flex; align-items:center; justify-content:space-between; padding:0.8rem 1.5rem; border-bottom:1px solid var(--bdr); background:rgba(8,8,13,.9); backdrop-filter:blur(20px); }
.logo { font-family:'Cinzel',serif; font-weight:700; color:var(--gold); letter-spacing:.12em; font-size:1rem; }
.logo span { color:var(--tx2); font-weight:400; letter-spacing:.04em; font-size:.85rem; margin-left:.5rem; }
.status { display:flex; align-items:center; gap:1.2rem; }
.status-item { font-family:'JetBrains Mono',monospace; font-size:.7rem; color:var(--tx2); display:flex; align-items:center; gap:.4rem; }
.pulse { width:8px; height:8px; border-radius:50%; background:var(--gold); animation:pulse 2s ease-in-out infinite; }
@keyframes pulse { 0%,100% { opacity:1; box-shadow:0 0 4px var(--gold); } 50% { opacity:.4; box-shadow:none; } }
.status-dot { width:6px; height:6px; border-radius:50%; }

/* Emotion Bar */
.emo-bar { display:flex; gap:2px; height:3px; width:120px; border-radius:2px; overflow:hidden; }
.emo-bar div { height:100%; transition:width .5s ease; border-radius:1px; }
.emo-c { background:#4ECDC4; } /* curiosity - teal */
.emo-s { background:#45B7D1; } /* satisfaction - blue */
.emo-f { background:#C94C4C; } /* frustration - red */
.emo-e { background:var(--gold); } /* excitement - gold */
.emo-fo { background:#A78BFA; } /* focus - purple */
.emo-em { background:#F472B6; } /* empathy - pink */
.emo-co { background:#34D399; } /* confidence - green */

/* Chat Panel */
.chat-panel { display:flex; flex-direction:column; border-right:1px solid var(--bdr); overflow:hidden; }
.messages { flex:1; overflow-y:auto; padding:1.5rem; scroll-behavior:smooth; }
.messages::-webkit-scrollbar { width:4px; }
.messages::-webkit-scrollbar-thumb { background:var(--bdr); border-radius:2px; }

.msg { max-width:85%; margin-bottom:1.2rem; animation:fadeIn .3s ease; }
@keyframes fadeIn { from { opacity:0; transform:translateY(8px); } to { opacity:1; transform:translateY(0); } }
.msg-user { margin-left:auto; }
.msg-ai { margin-right:auto; }
.msg-bubble { padding:.8rem 1.1rem; border-radius:12px; }
.msg-user .msg-bubble { background:var(--user-bg); border:1px solid var(--bdr); border-bottom-right-radius:4px; }
.msg-ai .msg-bubble { background:var(--ai-bg); border:1px solid rgba(255,255,255,.04); border-bottom-left-radius:4px; }
.msg-meta { font-family:'JetBrains Mono',monospace; font-size:.65rem; color:var(--txd); margin-top:.3rem; padding:0 .2rem; }
.msg-user .msg-meta { text-align:right; }
.msg-ai .msg-meta { display:flex; align-items:center; gap:.5rem; }
.msg-bubble code { font-family:'JetBrains Mono',monospace; background:rgba(201,168,76,.08); padding:.1rem .35rem; border-radius:3px; font-size:.85em; }
.msg-bubble pre { background:rgba(0,0,0,.4); border:1px solid var(--bdr); padding:.6rem .8rem; border-radius:6px; margin:.5rem 0; overflow-x:auto; font-family:'JetBrains Mono',monospace; font-size:.82em; line-height:1.5; }

/* Input */
.input-area { padding:.8rem 1rem; border-top:1px solid var(--bdr); background:var(--bg2); display:flex; gap:.6rem; align-items:flex-end; }
.input-area textarea { flex:1; background:var(--bg3); border:1px solid var(--bdr); border-radius:8px; padding:.6rem .9rem; color:var(--tx); font-family:'EB Garamond',serif; font-size:1rem; resize:none; outline:none; min-height:44px; max-height:150px; line-height:1.5; transition:border-color .2s; }
.input-area textarea:focus { border-color:var(--gold-d); }
.input-area textarea::placeholder { color:var(--txd); }
.send-btn { background:var(--gold); color:var(--bg); border:none; border-radius:8px; padding:.55rem 1rem; font-family:'Cinzel',serif; font-weight:600; font-size:.8rem; letter-spacing:.04em; cursor:pointer; transition:all .2s; white-space:nowrap; }
.send-btn:hover { background:var(--gold-b); transform:translateY(-1px); }
.send-btn:disabled { opacity:.4; cursor:default; transform:none; }

/* Thought Panel */
.thought-panel { display:flex; flex-direction:column; overflow:hidden; background:rgba(0,0,0,.15); }
.tp-header { padding:.8rem 1.2rem; border-bottom:1px solid var(--bdr); display:flex; align-items:center; justify-content:space-between; }
.tp-header h3 { font-family:'Cinzel',serif; font-size:.85rem; color:var(--gold-d); letter-spacing:.08em; font-weight:600; }
.tp-count { font-family:'JetBrains Mono',monospace; font-size:.65rem; color:var(--txd); }
.thought-stream { flex:1; overflow-y:auto; padding:1rem; }
.thought-stream::-webkit-scrollbar { width:3px; }
.thought-stream::-webkit-scrollbar-thumb { background:var(--bdr); border-radius:2px; }

.thought { padding:.6rem .8rem; margin-bottom:.6rem; border-left:2px solid var(--gold-d); background:var(--thought); border-radius:0 6px 6px 0; animation:thoughtIn .4s ease; font-size:.9rem; color:var(--tx2); line-height:1.5; }
@keyframes thoughtIn { from { opacity:0; transform:translateX(-10px); } to { opacity:1; transform:translateX(0); } }
.thought-time { font-family:'JetBrains Mono',monospace; font-size:.6rem; color:var(--txd); margin-top:.3rem; }
.thought-new { border-left-color:var(--gold); background:rgba(201,168,76,.06); }
.thought code, .thought pre { font-family:'JetBrains Mono',monospace; font-size:.82em; }
.thought pre { background:rgba(0,0,0,.3); padding:.4rem .6rem; border-radius:4px; margin:.3rem 0; overflow-x:auto; }

/* Thinking indicator */
.thinking { display:flex; align-items:center; gap:.4rem; padding:.5rem .8rem; margin-bottom:.6rem; }
.thinking span { width:4px; height:4px; background:var(--gold); border-radius:50%; animation:dot 1.4s infinite; }
.thinking span:nth-child(2) { animation-delay:.2s; }
.thinking span:nth-child(3) { animation-delay:.4s; }
@keyframes dot { 0%,100% { opacity:.2; } 50% { opacity:1; } }
.thinking-label { font-family:'JetBrains Mono',monospace; font-size:.65rem; color:var(--txd); margin-left:.3rem; }

/* Welcome state */
.welcome { text-align:center; padding:4rem 2rem; }
.welcome h2 { font-family:'Cinzel',serif; font-size:1.6rem; color:var(--gold); margin-bottom:1rem; }
.welcome p { color:var(--tx2); max-width:500px; margin:0 auto .8rem; }
.welcome .mono { font-family:'JetBrains Mono',monospace; font-size:.75rem; color:var(--txd); }

/* Connection states */
.offline { opacity:.5; pointer-events:none; }
.connecting { animation:pulse 1s infinite; }
</style>
</head>
<body>
<div class="app">
    <header>
        <div class="logo">TENGWAR AI <span>always thinking</span></div>
        <div class="status">
            <div class="emo-bar" id="emoBar" title="Emotional state">
                <div class="emo-c" style="width:17%"></div>
                <div class="emo-s" style="width:14%"></div>
                <div class="emo-f" style="width:0%"></div>
                <div class="emo-e" style="width:14%"></div>
                <div class="emo-fo" style="width:14%"></div>
                <div class="emo-em" style="width:14%"></div>
                <div class="emo-co" style="width:14%"></div>
            </div>
            <div class="status-item"><div class="pulse" id="statusDot"></div><span id="statusText">connecting...</span></div>
            <div class="status-item">ðŸ’­ <span id="thoughtCount">0</span></div>
        </div>
    </header>

    <div class="chat-panel">
        <div class="messages" id="messages">
            <div class="welcome" id="welcome">
                <h2>Tengwar AI</h2>
                <p>I'm always thinking â€” even right now, between your messages. I have permanent memory and genuine emotional states that evolve over time.</p>
                <p>I code exclusively in Tengwar. Ask me anything, or just watch me think.</p>
                <p class="mono">Watch the thought stream â†’</p>
            </div>
        </div>
        <div class="input-area">
            <textarea id="input" placeholder="Talk to Tengwar AI..." rows="1"></textarea>
            <button class="send-btn" id="sendBtn" onclick="sendMessage()">Send</button>
        </div>
    </div>

    <div class="thought-panel">
        <div class="tp-header">
            <h3>ðŸ’­ Thought Stream</h3>
            <span class="tp-count" id="tpCount">live</span>
        </div>
        <div class="thought-stream" id="thoughtStream">
            <div class="thinking" id="thinkingIndicator">
                <span></span><span></span><span></span>
                <span class="thinking-label">thinking...</span>
            </div>
        </div>
    </div>
</div>

<script>
const WS_URL = `${location.protocol === 'https:' ? 'wss:' : 'ws:'}//${location.host}/ws`;
let ws = null;
let reconnectTimer = null;
let thoughtCount = 0;
let streaming = false;
let currentAiMsg = null;

// DOM refs
const messagesEl = document.getElementById('messages');
const inputEl = document.getElementById('input');
const sendBtn = document.getElementById('sendBtn');
const thoughtStream = document.getElementById('thoughtStream');
const statusDot = document.getElementById('statusDot');
const statusText = document.getElementById('statusText');
const thoughtCountEl = document.getElementById('thoughtCount');
const tpCount = document.getElementById('tpCount');
const emoBar = document.getElementById('emoBar');
const welcome = document.getElementById('welcome');
const thinkingIndicator = document.getElementById('thinkingIndicator');

function connect() {
    if (ws && ws.readyState <= 1) return;
    ws = new WebSocket(WS_URL);

    ws.onopen = () => {
        statusDot.style.background = 'var(--gold)';
        statusText.textContent = 'thinking';
        clearTimeout(reconnectTimer);
    };

    ws.onmessage = (e) => {
        const data = JSON.parse(e.data);

        if (data.type === 'connected') {
            thoughtCount = data.thought_count || 0;
            thoughtCountEl.textContent = thoughtCount;
            updateEmotions(data.emotions);
        }

        if (data.type === 'thought') {
            addThought(data);
            thoughtCount = data.thought_number || thoughtCount + 1;
            thoughtCountEl.textContent = thoughtCount;
            if (data.emotion) updateEmotions(data.emotion);
        }

        if (data.type === 'chat_token') {
            if (!currentAiMsg) {
                currentAiMsg = addMessage('', 'ai');
            }
            const bubble = currentAiMsg.querySelector('.msg-bubble');
            bubble.innerHTML = formatContent(bubble.dataset.raw = (bubble.dataset.raw || '') + data.token);
            messagesEl.scrollTop = messagesEl.scrollHeight;
        }

        if (data.type === 'chat_done') {
            streaming = false;
            sendBtn.disabled = false;
            currentAiMsg = null;
            if (data.emotions) updateEmotions(data.emotions);
        }
    };

    ws.onclose = () => {
        statusDot.style.background = '#C94C4C';
        statusText.textContent = 'reconnecting...';
        reconnectTimer = setTimeout(connect, 3000);
    };

    ws.onerror = () => ws.close();
}

function addThought(data) {
    const el = document.createElement('div');
    el.className = 'thought thought-new';
    const time = data.timestamp ? new Date(data.timestamp).toLocaleTimeString() : 'now';
    el.innerHTML = `
        <div>${formatContent(data.content)}</div>
        <div class="thought-time">#${data.thought_number || '?'} Â· ${time}</div>
    `;
    thoughtStream.insertBefore(el, thinkingIndicator.nextSibling);
    // Remove "new" highlight after a moment
    setTimeout(() => el.classList.remove('thought-new'), 3000);
    // Keep stream scrolled to top (newest)
    thoughtStream.scrollTop = 0;
    tpCount.textContent = 'live';
}

function addMessage(content, role) {
    if (welcome) welcome.style.display = 'none';
    const msg = document.createElement('div');
    msg.className = `msg msg-${role}`;
    const time = new Date().toLocaleTimeString();
    msg.innerHTML = `
        <div class="msg-bubble" data-raw="${role === 'ai' ? '' : ''}">${formatContent(content)}</div>
        <div class="msg-meta">${role === 'ai' ? 'ðŸ§  Tengwar AI Â· ' : ''}${time}</div>
    `;
    if (role === 'ai') msg.querySelector('.msg-bubble').dataset.raw = content;
    messagesEl.appendChild(msg);
    messagesEl.scrollTop = messagesEl.scrollHeight;
    return msg;
}

function sendMessage() {
    const text = inputEl.value.trim();
    if (!text || streaming) return;

    addMessage(text, 'user');
    inputEl.value = '';
    inputEl.style.height = 'auto';
    streaming = true;
    sendBtn.disabled = true;
    currentAiMsg = null;

    ws.send(JSON.stringify({ type: 'chat', content: text }));
}

function updateEmotions(e) {
    if (!e) return;
    const total = e.curiosity + e.satisfaction + e.frustration + e.excitement + e.focus + e.empathy + e.confidence;
    const pct = (v) => ((v / total) * 100).toFixed(1) + '%';
    const bars = emoBar.children;
    bars[0].style.width = pct(e.curiosity);
    bars[1].style.width = pct(e.satisfaction);
    bars[2].style.width = pct(e.frustration);
    bars[3].style.width = pct(e.excitement);
    bars[4].style.width = pct(e.focus);
    bars[5].style.width = pct(e.empathy);
    bars[6].style.width = pct(e.confidence);
    emoBar.title = `Curiosity: ${(e.curiosity*100).toFixed(0)}% | Satisfaction: ${(e.satisfaction*100).toFixed(0)}% | Frustration: ${(e.frustration*100).toFixed(0)}% | Excitement: ${(e.excitement*100).toFixed(0)}% | Focus: ${(e.focus*100).toFixed(0)}% | Empathy: ${(e.empathy*100).toFixed(0)}% | Confidence: ${(e.confidence*100).toFixed(0)}%`;
}

function formatContent(text) {
    if (!text) return '';
    // Code blocks
    text = text.replace(/```(\w*)\n?([\s\S]*?)```/g, '<pre>$2</pre>');
    // Inline code
    text = text.replace(/`([^`]+)`/g, '<code>$1</code>');
    // Bold
    text = text.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
    // Italic
    text = text.replace(/\*(.+?)\*/g, '<em>$1</em>');
    // Newlines
    text = text.replace(/\n/g, '<br>');
    return text;
}

// Auto-resize textarea
inputEl.addEventListener('input', () => {
    inputEl.style.height = 'auto';
    inputEl.style.height = Math.min(inputEl.scrollHeight, 150) + 'px';
});

// Enter to send (Shift+Enter for newline)
inputEl.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
    }
});

// Boot
connect();
</script>
</body>
</html>
